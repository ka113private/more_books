{% extends 'base.html' %}

{% load static %}

{% block title %}人生を変える本に出会おう。More Books!{% endblock %}

{% block header %}
    {% include 'recommend_modal.html' %}
{% endblock %}

{% block contents %}
<!-- hero section -->
<section class="hero hero-index vh-100 d-flex align-items-center">
    <div class="container">
        <div class="row">
            <div class="col-lg-7 mx-auto text-center">
                <h1 class="display-4">人生を変える本に出会おう。</h1>
                <h1 class="display-4">More Books!</h1>

                {% if user.is_authenticated %}
                    <a type="button" class="btn-exploration btn btn-outline-light btn-lg" data-toggle="modal" data-target="#recommend-modal">
                        新しい本と出会う
                    </a>
                {% else %}
                    <a type="button" class="btn-exploration btn btn-outline-light btn-lg" href="{% url 'account_login' %}">
                        新しい本と出会う
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block javascript %}

    <!-- var bookContainer = document.getElementById('book_detail'); -->
    var thumbnailImage = document.getElementById('thumbnail_image');
    var bookElement = document.createElement('div');
    var btnAddMybooks = document.getElementById('add_mybooks');
    var btnNotAddMybooks = document.getElementById('not_add_mybooks');
    var btnClose = document.getElementById('close');

    document.getElementById('btn_related_books').addEventListener('click', e => {
        const url = '{% url "books:get_related_books" %}';
        e.preventDefault();
        getRecommendBooks(url)
    });

    document.getElementById('btn_new_books').addEventListener('click', e => {
        const url = '{% url "books:get_new_books" %}';
        e.preventDefault();
        getRecommendBooks(url)
    });

    <!-- レコメンド書籍リストをサーバから取得する -->
    function getRecommendBooks(url){
        fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json; charset=utf-8',
                'X-CSRFToken': '{{ csrf_token }}',
                },
            }).then(response => {
                return response.json();
            }).then(data => {
                if(data.recommend_exists){
                    bookList = JSON.parse(data.recommend_books);//JSONデータからリストを取得する。
                    var next_book = bookList.books[0];//リストの先頭オブジェクトを取得する。
                    <!--bookElement.innerHTML = `<h6>${next_book.title}</h6><p>${next_book.author}</p>`;-->
                    <!--bookContainer.appendChild(bookElement);-->
                    thumbnailImage.src = './../media/' + next_book.thumbnail_image;
                    btnAddMybooks.style.display = 'inline'
                    btnNotAddMybooks.style.display = 'inline'
                    btnClose.style.display = 'none'
                }else{
                    <!--bookElement.innerHTML = `<p>おすすめできる本は他にございません。しばらく時間がたってからまたお試しください。</p>`;-->
                    bookContainer.appendChild(bookElement);
                    thumbnailImage.src = './../media/static/sorry.png';
                    btnAddMybooks.style.display = 'none'
                    btnNotAddMybooks.style.display = 'none'
                    btnClose.style.display = 'inline'
                }
        }).catch(error => {
            console.log(error);
        });
    }

    <!-- 「読みたい」を押した場合（Ajax）-->
    document.getElementById('add_mybooks').addEventListener('click', e => {
        const jsonData = JSON.stringify(bookList);
        const url = '{% url "books:add_mybooks" %}';
        e.preventDefault();
        fetchData(url, jsonData)
    });

    <!-- 「興味ない」を押した場合（Ajax）-->
    document.getElementById('not_add_mybooks').addEventListener('click', e => {
        const jsonData = JSON.stringify(bookList);
        const url = '{% url "books:not_add_mybooks" %}';
        e.preventDefault();
        fetchData(url, jsonData)
    });

    <!-- レコメンド書籍リストをviewに渡す処理 -->
    function fetchData(url, data){
        fetch(url, {
            method: 'POST',
            body: data,
            headers: {
                'Content-Type': 'application/json; charset=utf-8',
                'X-CSRFToken': '{{ csrf_token }}',
                },
            }).then(response => {
                return response.json();
            }).then(data => {
                if(data.exists){
                    bookList = JSON.parse(data.next_books);//JSONデータからリストを取得する。
                    var next_book = bookList.books[0];//リストの先頭オブジェクトを取得する。
                    <!--bookElement.innerHTML = `<h6>${next_book.title}</h6><p>${next_book.author}</p>`;-->
                    thumbnailImage.src = './../media/' + next_book.thumbnail_image;
                    btnAddMybooks.style.display = 'inline'
                    btnNotAddMybooks.style.display = 'inline'
                    btnClose.style.display = 'none'
                }else{
                    <!--bookElement.innerHTML = `<p>おすすめできる本は他にございません。しばらく時間がたってからまたお試しください。</p>`;-->
                    thumbnailImage.src = './../media/static/sorry.png';
                    btnAddMybooks.style.display = 'none'
                    btnNotAddMybooks.style.display = 'none'
                    btnClose.style.display = 'inline'
                }
        }).catch(error => {
            console.log(error);
        });
    }
{% endblock %}