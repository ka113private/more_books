{% extends 'base.html' %}

{% load static %}

{% block title %}人生を変える本に出会おう。More Books!{% endblock %}

{% block header %}
    {% include 'recommend_modal.html' %}
{% endblock %}

{% block contents %}

<!-- hero section -->
{% if user.is_authenticated %}
<section class="hero hero-index-afterauth vh-100 d-flex align-items-center">
    <div class="container">
        <div class="row">
            <div class="index-afterauth-content col-md-7 mx-auto text-center">
                <a type="button" class="btn-exploration btn btn-outline-light btn-lg" id="btn_related_books" data-toggle="modal" data-target="#recommend-modal">
                    店主におすすめを聞いてみる
                </a>
            </div>
        </div>
    </div>
</section>
<section class="book-categories">
    <div class="container">
        <div class="section-title">
            <div class="section-title-en">Recommends</div>
            <div class="section-title-jp">今月のオススメ</div>
        </div>
    </div>
</section>
<section class="book-categories">
    <div class="container">
        <div class="section-title">
            <div class="section-title-en">Book Category</div>
            <div class="section-title-jp">カテゴリ一覧</div>
        </div>
        <div class="row d-flex justify-content-center my-5 gy-4">
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="category">
                    <a href="{% url 'books:book_list_from_category' 1 %}">
                        <img src="./static/assets/img/cat_literature.jpg" alt="">
                        <div class="overlay">
                            <div class="category-name-en">Literature</div>
                            <div class="category-name-jp">文学・評論</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="category">
                    <a href="{% url 'books:book_list_from_category' 2 %}">
                        <img src="./static/assets/img/cat_thought.jpg" alt="">
                        <div class="overlay">
                            <div class="category-name-en">Thought</div>
                            <div class="category-name-jp">人文・思想</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="category">
                    <a href="{% url 'books:book_list_from_category' 3 %}">
                        <img src="./static/assets/img/cat_society_politics.jpg" alt="">
                        <div class="overlay">
                            <div class="category-name-en">Society ＆ Politics</div>
                            <div class="category-name-jp">社会・政治</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="category">
                    <a href="{% url 'books:book_list_from_category' 4 %}">
                        <img src="./static/assets/img/cat_nonfiction.jpg" alt="">
                        <div class="overlay">
                            <div class="category-name-en">Non-Fiction</div>
                            <div class="category-name-jp">ノンフィクション</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="category">
                    <a href="{% url 'books:book_list_from_category' 5 %}">
                        <img src="./static/assets/img/cat_history_geography.jpg" alt="">
                        <div class="overlay">
                            <div class="category-name-en">History ＆ Geography</div>
                            <div class="category-name-jp">歴史・地理</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="category">
                    <a href="{% url 'books:book_list_from_category' 6 %}">
                        <img src="./static/assets/img/cat_business_economics.jpg" alt="">
                        <div class="overlay">
                            <div class="category-name-en">Business ＆ Economics</div>
                            <div class="category-name-jp">ビジネス・経済</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="category">
                    <a href="{% url 'books:book_list_from_category' 7 %}">
                        <img src="./static/assets/img/cat_finance_management.jpg" alt="">
                        <div class="overlay">
                            <div class="category-name-en">Finance ＆ Management</div>
                            <div class="category-name-jp">投資・金融・会社経営</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="category">
                    <a href="{% url 'books:book_list_from_category' 8 %}">
                        <img src="./static/assets/img/cat_science_technology.jpg" alt="">
                        <div class="overlay">
                            <div class="category-name-en">Science ＆ Technology</div>
                            <div class="category-name-jp">科学・テクノロジー</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="category">
                    <a href="{% url 'books:book_list_from_category' 9 %}">
                        <img src="./static/assets/img/cat_medicine_pharmacy.jpg" alt="">
                        <div class="overlay">
                            <div class="category-name-en">Medicine ＆ Pharmacy</div>
                            <div class="category-name-jp">医学・薬学・看護学・歯科学</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="category">
                    <a href="{% url 'books:book_list_from_category' 10 %}">
                        <img src="./static/assets/img/cat_computer_it.jpg" alt="">
                        <div class="overlay">
                            <div class="category-name-en">Computer ＆ IT</div>
                            <div class="category-name-jp">コンピュータ・IT</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="category">
                    <a href="{% url 'books:book_list_from_category' 11 %}">
                        <img src="./static/assets/img/cat_art_architecture.jpg" alt="">
                        <div class="overlay">
                            <div class="category-name-en">Art ＆ Architecture</div>
                            <div class="category-name-jp">アート・建築・デザイン</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="category">
                    <a href="{% url 'books:book_list_from_category' 12 %}">
                        <img src="./static/assets/img/cat_practical.jpg" alt="">
                        <div class="overlay">
                            <div class="category-name-en">Practical</div>
                            <div class="category-name-jp">実用</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="category">
                    <a href="{% url 'books:book_list_from_category' 13 %}">
                        <img src="./static/assets/img/cat_hobby.jpg" alt="">
                        <div class="overlay">
                            <div class="category-name-en">Hobby</div>
                            <div class="category-name-jp">趣味</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="category">
                    <a href="{% url 'books:book_list_from_category' 14 %}">
                        <img src="./static/assets/img/cat_sports.jpg" alt="">
                        <div class="overlay">
                            <div class="category-name-en">Sports</div>
                            <div class="category-name-jp">スポーツ</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="category">
                    <a href="{% url 'books:book_list_from_category' 15 %}">
                        <img src="./static/assets/img/cat_outdoors.jpg" alt="">
                        <div class="overlay">
                            <div class="category-name-en">Outdoors</div>
                            <div class="category-name-jp">アウトドア</div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="category">
                    <a href="{% url 'books:book_list_from_category' 16 %}">
                        <img src="./static/assets/img/cat_qualification.jpg" alt="">
                        <div class="overlay">
                            <div class="category-name-en">Qualification</div>
                            <div class="category-name-jp">資格・検定・就職</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        <div class="row d-flex justify-content-center">
            <div class="col-lg-6 col-sm-12">
                <form class="search-form d-flex align-items-center" action="{% url 'books:book_list_from_search' %}" method="get">
                    <input class="form-control form-control-sm me-2" size="45" type="search" name="query" placeholder="Search" aria-label="Search">
                    <button type="submit"><i class="fa-solid fa-magnifying-glass"></i></button>
                </form>
            </div>
        </div>
    </div>
</section>

{% else %}

<section class="hero hero-index-beforeauth vh-100 d-flex align-items-center">
    <div class="container">
        <div class="row">
            <div class="col-md-7 mx-auto text-center">
                <h1 class="copy display-4">人生を変える本に出会おう。</h1>
                <h1 class="copy display-4">More Books!</h1>
                <a type="button" class="btn-exploration btn btn-outline-light btn-lg" href="{% url 'account_login' %}">
                    新しい本と出会う
                </a>
            </div>
        </div>
    </div>
</section>

{% endif %}
{% endblock %}

{% block javascript %}
    var thumbnailImage = document.getElementById('thumbnail_image');
    var btnLike = document.getElementById('btn_like');
    var btnUnLike = document.getElementById('btn_unlike');
    var btnRelatedBooks = document.getElementById('btn_related_books');

    <!-- サーバから提案書籍リストを取得　-->
    btnRelatedBooks.addEventListener('click', e => {
        const url = '{% url "books:get_related_books" %}';
        e.preventDefault();
        getRecommendBooks(url)
    });

    btnLike.addEventListener('click', e => {
        const jsonData = JSON.stringify(bookList);
        const url = '{% url "books:add_mybooks" %}';
        e.preventDefault();
        fetchData(url, jsonData);
    });

    btnUnLike.addEventListener('click', e => {
        const jsonData = JSON.stringify(bookList);
        const url = '{% url "books:not_add_mybooks" %}';
        e.preventDefault();
        fetchData(url, jsonData);
    });

    <!-- レコメンド書籍リストをサーバから取得する -->
    function getRecommendBooks(url){
        fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json; charset=utf-8',
                'X-CSRFToken': '{{ csrf_token }}',
                },
            }).then(response => {
                return response.json();
            }).then(data => {
                if(data.recommend_exists){
                    bookList = JSON.parse(data.recommend_books);//JSONデータからリストを取得する。
                    var next_book = bookList.books[0];//リストの先頭オブジェクトを取得する。
                    thumbnailImage.src = '../../media/' + next_book.thumbnail_image;
                }else{
                    thumbnailImage.src = '../../media/static/sorry.png';
                }
        }).catch(error => {
            console.log(error);
        });
    }

    <!-- レコメンド書籍リストをviewに渡す処理 -->
    function fetchData(url, data){
        fetch(url, {
            method: 'POST',
            body: data,
            headers: {
                'Content-Type': 'application/json; charset=utf-8',
                'X-CSRFToken': '{{ csrf_token }}',
                },
            }).then(response => {
                return response.json();
            }).then(data => {
                if(data.exists){
                    bookList = JSON.parse(data.next_books);//JSONデータからリストを取得する。
                    var next_book = bookList.books[0];//リストの先頭オブジェクトを取得する。
                    thumbnailImage.src = '../../media/' + next_book.thumbnail_image;
                }else{
                    thumbnailImage.src = '../../media/static/sorry.png';
                }
        }).catch(error => {
            console.log(error);
        });
    }
{% endblock %}